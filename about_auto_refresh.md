# 自动刷新和自动插入助手（代码片段）的风险说明

## 举例

当挂件更新文档内的目录列表（或保存设置）后，当前设备文档编辑时间将更新。如果刷新时当前设备未同步，则再次同步后，新文档会覆盖云端内容，导致其他设备的编辑丢失。

> 设备A对文档进行了编辑。（这个文档有子文档，或者这个文档插入了listChildDocs挂件，且1.打开了对文档中目录列表的自动刷新2.关闭了安全模式）
> 
> 如果因为网络原因设备B没能在启动前完成同步，启动后，自动刷新将更新文档，并使得文档为刚刚编辑的状态；之后再次进行同步，设备B将覆盖设备A的文档内容，导致设备A对文档的编辑丢失。

如果文档较多，刷新将比较慢，可能出现编辑/浏览过程中突然更新目录列表/修改子文档链接的情况。

## 关于文档中目录列表自动刷新

### 可以使用的情况

满足以下情况之一，可以关闭挂件安全模式`safeMode`，并启用文档内自动刷新：

- 只在一台设备使用，不使用任何形式的同步；
- 挂件所在文档只作为目录使用，不进行其他编辑，无其他笔记内容（所在文档被覆盖也无所谓）；

### 绝对不可以使用的情况

满足以下情况之一，不可以关闭挂件安全模式`safeMode`：

- 使用同步，挂件所在文档有其他笔记内容；

  （自动刷新可能导致文档覆盖）

### 若要在使用同步的情况下开启文档内自动刷新

不建议在启用同步时关闭安全模式。如果仍要继续，请确保：

1. 在挂件配置文件中启用只读安全模式`safeModePlus`；
2. 在所有设备将 设置-编辑器-只读模式 设定为开启；
3. 保证在完成同步之前：

   - 不切换为编辑模式；
   - 不双击挂件刷新按钮；
   - 不进行文档创建、重命名或删除操作；

如果使用同步盘，请确保：

- 在思源运行期间暂停同步；
- 在思源启动之前完成同步；

### 使用说明

如果确定您的情况可以使用自动刷新，那么修改`config.js`（或`custom.js`）的`safeMode`为`false`来关闭安全模式。

## 关于自动插入助手（代码片段）

### 风险说明

- 自动插入助手模式为`插入挂件`：
  
  （可能导致文档编辑卡顿）

- 自动插入助手模式为`插入链接`、`插入引用块`、`插入自定义`：
  
  （可能导致打开、切换文档卡顿）

多用户访问（e.g. 使用浏览器打开了多个思源窗口）时，有可能导致重复插入挂件/子文档链接；

出现上述情况，请停止使用自动插入助手。（设置-外观-代码片段-JS 移除代码片段，然后重新启动思源）

### 可以使用的情况

满足以下情况之一，可以在启用自动插入助手：

- 只在一台设备使用，不使用任何形式的同步；
- 父文档（有子文档的文档）只作为目录使用，不进行其他编辑，无其他笔记内容（父文档被同步覆盖也无所谓）；

### 绝对不可以使用的情况

满足以下情况之一，不可以启用自动插入助手：

- 使用同步，父文档要写其他内容；

  （自动插入的链接可能同步覆盖）

- 多个用户通过浏览器访问；

### 不建议使用的情况

满足以下情况之一，不建议启用自动插入助手：

- 存在多个窗口同时打开的情况（多个浏览器页面访问思源、浏览器和客户端同时打开）；
  
  （有概率导致重复插入挂件或链接）

- 使用`网络伺服`；

  （有概率导致重复插入挂件或链接）

- 使用docker；

  （有概率导致重复插入挂件或链接）

### 自动插入助手使用说明

#### 插入设置

在`config.js`（或`custom.js`）中修改配置`helperSettings`，具体配置项见文件内的说明。

#### 启用

1. 在`config.js`中启用只读安全模式`safeModePlus`。

2. 在 设置-外观-代码片段-JS 中添加代码片段：

    ```javascript
    import("/widgets/listChildDocs/src/addChildDocLinkHelper.js");
    // 如果挂件位置有更改，需要修改
    // import("/widgets/挂件所在文件夹/src/addChildDocLinkHelper.js");
    ```

#### 禁用

在 设置-外观-代码片段-JS 中删除代码片段，然后重新启动思源。