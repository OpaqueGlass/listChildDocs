# 同步风险说明

> 更新于listChildDocs版本v0.1.1-beta5

## 多端同步前刷新可能导致同步覆盖

如果进行自动刷新时并没有和其他设备进行同步，那么设备的旧文档将覆盖云端的新文档，可能导致其他设备的编辑丢失。

> 模式为`默认`、`挂件beta`（目录列表在挂件中展示）时，自动刷新对文档没有修改，不会导致同步覆盖。

<u>（手动刷新、保存挂件设置仍可能导致同步覆盖，请不要在未同步时进行这些操作）</u>

## 关于文档中目录列表自动刷新

### 触发时机

- 挂件被加载时（例如以下情景：）

  - 打开挂件所在文档（例如从文档树打开）；
  - 浏览挂件所在文档时，由于文档较长挂件被动态加载；
  - 思源启动时，将恢复上次未关闭的文档，如果这些文档里有挂件，那么也进行刷新；
  - 挂件或所在文档显示在浮窗中。

- 点击页签切换到所在文档时（默认仅windows，可通过修改配置文件`includeOs`更改/禁用）；

### 可以使用的情况

满足以下情况之一，可以关闭安全模式`safeMode`，并启用文档内自动刷新：

- 只在一台设备使用，不使用任何形式的同步；
- 挂件所在文档只作为目录使用，不进行其他编辑，无其他笔记内容（所在文档被覆盖也无所谓）；

### 绝对不可以使用的情况

满足以下情况之一，不可以关闭安全模式`safeMode`：

- 使用同步，挂件所在文档有其他笔记内容；

  （自动刷新可能导致文档覆盖）

### 在使用同步的情况下，开启文档内自动刷新

不建议在启用同步时关闭安全模式。如果仍要继续，请确保：

1. 在挂件配置文件中启用只读安全模式`safeModePlus`；
2. 在所有设备将 设置-编辑器-只读模式 设定为开启；
3. 保证在完成同步之前：

   - 不切换为编辑模式；
   - 不双击挂件刷新按钮；
   - 不进行文档创建、重命名或删除操作；

### 在使用同步盘同步的情况下，开启文档内自动刷新

如果使用第三方同步盘，请确保：

- 在思源启动之前完成同步；
- 在思源运行期间暂停同步；

### 使用说明

如果确定您的情况可以使用自动刷新，那么

1. 修改`config.js`（或`custom.js`）的`safeMode`为`false`来关闭安全模式;

2. 在挂件内勾选自动刷新，并双击刷新按钮保存；

【建议同时开启只读安全模式`safeModePlus`】

## 关于自动插入助手（代码片段）

> 注意：⚠请在阅读以下内容、接受风险后使用。

### 风险说明

- 自动插入助手模式为`插入挂件`：
  
  若设置为创建子文档时插入，**（可能导致文档编辑卡顿）**

  若设置为打开空白父文档时插入，**（可能导致文档打开、切换卡顿）**

- 自动插入助手模式为`插入链接`、`插入引用块`、`插入自定义`：

  可能导致打开、切换文档卡顿。**开发者未测试，这些模式可能存在其他问题，请勿使用**

如果有多个窗口界面（包括浏览器页面），将同时运行着多个自动插入助手，有可能导致**重复插入挂件/子文档链接**；

出现上述情况，请停止使用自动插入助手。（设置-外观-代码片段-JS 移除代码片段，然后重新启动思源）

### 自动插入触发时机

> 本部分只介绍默认设置下的触发时机，若更改了config.js `helperSettings`，请以配置为准。

- 自动插入助手模式为`插入挂件`：

  打开文档时，获取该文档的子文档。如果该文档有子文档且文档为空（只有空格或空段落块也认为空），则插入挂件；

  > 若设置为创建子文档时插入：在文档树点击+新建文档后，判断父文档是否为空（只有空格或空段落块也认为空），为空则插入挂件；

- 自动插入助手模式为`插入链接`、`插入引用块`、`插入自定义`：
  
  打开任意文档时，获取该文档的子文档，如果发现子文档变动，则进行对应修改。

### 可以使用的情况

满足以下情况之一，可以在启用自动插入助手：

- 只在一台设备使用，不使用任何形式的同步；
- 父文档（有子文档的文档）只作为目录使用，不进行其他编辑，无其他笔记内容（父文档被同步覆盖也无所谓）；

### 绝对不可以使用的情况

满足以下情况之一，不可以启用自动插入助手：

- 使用同步，父文档要写其他内容；

- 多个用户通过浏览器访问；

### 不建议使用的情况

满足以下情况之一，有概率重复插入挂件，不建议启用自动插入助手：

- 使用浏览器访问思源，同时本地运行思源客户端；
  
- 使用`网络伺服`；

- 使用docker；

### 自动插入助手使用说明

#### 启用

1. 在`config.js`（或`custom.js`）中启用只读安全模式`safeModePlus`（设置为`true`）。

2. 在 设置-外观-代码片段-JS 中添加代码片段：

    ```javascript
    import("/widgets/listChildDocs/src/addChildDocLinkHelper.js");
    // 如果挂件位置有更改，需要修改
    // import("/widgets/挂件所在文件夹/src/addChildDocLinkHelper.js");
    ```

#### 禁用

在 设置-外观-代码片段-JS 中删除代码片段，然后重新启动思源。

#### 配置自动插入助手

在`config.js`（或`custom.js`）中修改配置`helperSettings`，具体配置项见`config.js`文件内的说明。

- 在切换页签时也检查、执行自动插入（默认禁用）：``；